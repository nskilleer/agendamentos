<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgendaFácil - Painel Profissional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <header class="header bg-blue-600 text-white p-4 flex justify-between items-center">
        <a href="painelpro" class="logo text-2xl font-bold">AgendaFácil</a>
        <button id="menu-toggle" class="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <nav id="nav-menu" class="nav-menu">
            <a href="painelpro" class="nav-link active">Início</a>
            <a href="agenda" class="nav-link">Agenda</a>
            <a href="config" class="nav-link">Configurações</a>
            <button id="logout-button" class="btn-secondary">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </nav>
    </header>

    <main class="container p-6 mx-auto">
        <div class="card bg-white p-6 rounded shadow-md mt-6">
            <h2 class="text-xl font-bold mb-2">
                Bem-vindo, <span id="nome-profissional" class="text-blue-600">...</span>
            </h2>
            <p class="text-gray-600">Seu painel profissional para gerenciar a agenda.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div class="card bg-white p-6 rounded shadow-md">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="far fa-calendar-alt text-blue-600 mr-2"></i> Agendamentos de Hoje
                </h2>
                <ul id="agendamentos-hoje">
                    <li class="text-gray-500">Carregando agendamentos...</li>
                </ul>
            </div>

            <div class="card bg-white p-6 rounded shadow-md">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-share-alt text-green-600 mr-2"></i> Compartilhar com Clientes
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    Envie o link para que seus clientes agendem um horário com você.
                </p>
                <div class="mb-4">
                    <label for="link-painel-cliente" class="block text-sm font-medium text-gray-700">Link do Painel do
                        Cliente</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="link-painel-cliente" readonly
                            class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 bg-gray-100 p-2 cursor-copy">
                        <button id="btn-copiar-link"
                            class="inline-flex items-center px-4 rounded-r-md border border-l-0 border-gray-300 bg-blue-600 text-white hover:bg-blue-700">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="mensagem-compartilhar" class="block text-sm font-medium text-gray-700">Mensagem
                        personalizada</label>
                    <textarea id="mensagem-compartilhar" rows="3"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        placeholder="Olá! Use este link para agendar um horário comigo."></textarea>
                </div>
                <button id="btn-compartilhar-whatsapp"
                    class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-500 hover:bg-green-600">
                    <i class="fab fa-whatsapp mr-2"></i> Compartilhar por WhatsApp
                </button>
            </div>
        </div>

        <div class="flex flex-wrap gap-4 mt-6 justify-center">
            <button id="verClientesButton"
                class="button flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                <i class="fas fa-users mr-2"></i> Ver Clientes
            </button>
            <a href="agenda"
                class="button flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                <i class="far fa-calendar-check mr-2"></i> Ir para a Agenda
            </a>
            <a href="config"
                class="button flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                <i class="fas fa-cog mr-2"></i> Configurações
            </a>
        </div>
    </main>

    <div id="modal-clientes" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h2 class="text-xl font-bold mb-4"><i class="fas fa-users mr-2"></i> Clientes Cadastrados</h2>
                <ul id="lista-clientes" class="text-left mb-4 max-h-80 overflow-y-auto">
                    <li class="text-gray-500">Carregando clientes...</li>
                </ul>
                <div class="items-center px-4 py-3">
                    <button id="btn-fechar-modal-clientes"
                        class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Adicionado código para o menu responsivo
            const menuToggle = document.getElementById('menu-toggle');
            const navMenu = document.getElementById('nav-menu');

            menuToggle.addEventListener('click', () => {
                navMenu.classList.toggle('open');
            });

            const logoutButton = document.getElementById('logout-button');
            const nomeProfissionalSpan = document.getElementById('nome-profissional');
            const listaAgendamentosHoje = document.getElementById('agendamentos-hoje');
            const verClientesButton = document.getElementById('verClientesButton');
            const modalClientes = document.getElementById('modal-clientes');
            const listaClientes = document.getElementById('lista-clientes');
            const btnFecharModalClientes = document.getElementById('btn-fechar-modal-clientes');
            const linkPainelClienteInput = document.getElementById('link-painel-cliente');
            const btnCopiarLink = document.getElementById('btn-copiar-link');
            const mensagemCompartilharTextarea = document.getElementById('mensagem-compartilhar');
            const btnCompartilharWhatsapp = document.getElementById('btn-compartilhar-whatsapp');

            let userId = null;

            const handleAuthError = (response) => {
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return true;
                }
                return false;
            };

            const showMessage = (element, message, isError = false) => {
                element.innerHTML = `<li class="text-sm p-2 ${isError ? 'text-red-500' : 'text-gray-500'}">${message}</li>`;
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Link copiado para a área de transferência!');
                }).catch(err => {
                    console.error('Erro ao copiar link:', err);
                    alert('Erro ao copiar link. Por favor, copie manualmente.');
                });
            };

            const generateShareLink = (id) => {
                return `${window.location.origin}/painelcli?pro_id=${id}`;
            };

            const initPage = async () => {
                try {
                    const sessionResponse = await fetch('/api/check_session', { credentials: 'include' });
                    if (sessionResponse.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }

                    const sessionData = await sessionResponse.json();

                    if (sessionData.success && sessionData.data.logged_in && sessionData.data.user_type === 'profissional') {
                        nomeProfissionalSpan.textContent = sessionData.data.user_name;
                        userId = sessionData.data.user_id;
                        linkPainelClienteInput.value = generateShareLink(userId);
                        await carregarAgendamentosHoje();
                    } else {
                        window.location.href = '/login.html';
                    }
                } catch (error) {
                    console.error('Erro na inicialização da página:', error);
                    window.location.href = '/login.html';
                }
            };

            const carregarAgendamentosHoje = async () => {
                showMessage(listaAgendamentosHoje, 'Carregando agendamentos...');
                try {
                    const response = await fetch('/api/agendamentos/hoje', { credentials: 'include' });
                    if (handleAuthError(response)) return;

                    const data = await response.json();

                    if (!data.success) {
                        showMessage(listaAgendamentosHoje, `Erro ao carregar: ${data.message}`, true);
                        return;
                    }

                    const agendamentos = data.data;

                    // FILTRANDO AGENDAMENTOS CANCELADOS
                    const agendamentosNaoCancelados = agendamentos.filter(agendamento => !agendamento.cancelado);

                    if (agendamentosNaoCancelados.length === 0) {
                        showMessage(listaAgendamentosHoje, 'Nenhum agendamento ativo para hoje.');
                        return;
                    }

                    listaAgendamentosHoje.innerHTML = '';
                    agendamentosNaoCancelados.forEach(event => {
                        const hora = new Date(event.start).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const telefoneLimpo = event.extendedProps.telefone ? event.extendedProps.telefone.replace(/\D/g, '') : '';
                        const whatsappLink = `https://wa.me/55${telefoneLimpo}`;

                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 border-b last:border-b-0';
                        li.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800">${event.title.split(' - ')[0]}</div>
                            <div class="text-sm text-gray-600"><i class="fas fa-cut mr-1"></i>${event.extendedProps.servico}</div>
                            <div class="text-xs text-gray-500"><i class="far fa-clock mr-1"></i>${hora}</div>
                        </div>
                        <a href="${whatsappLink}" target="_blank" class="text-green-500 hover:text-green-600">
                            <i class="fab fa-whatsapp text-2xl"></i>
                        </a>
                        `;
                        listaAgendamentosHoje.appendChild(li);
                    });
                } catch (error) {
                    console.error('Erro ao carregar agendamentos:', error);
                    showMessage(listaAgendamentosHoje, 'Erro ao carregar agendamentos.', true);
                }
            };

            const carregarClientes = async () => {
                showMessage(listaClientes, 'Carregando clientes...');
                try {
                    const response = await fetch('/api/clientes', { credentials: 'include' });
                    if (handleAuthError(response)) return;

                    const data = await response.json();

                    if (!data.success) {
                        showMessage(listaClientes, `Erro ao carregar: ${data.message}`, true);
                        return;
                    }

                    const clientes = data.data;

                    if (clientes.length === 0) {
                        showMessage(listaClientes, 'Nenhum cliente cadastrado.');
                        return;
                    }

                    listaClientes.innerHTML = '';
                    clientes.forEach(cliente => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 border-b last:border-b-0';
                        const whatsappLink = `https://wa.me/55${cliente.telefone.replace(/\D/g, '')}`;

                        li.innerHTML = `
                        <div>
                            <span class="font-bold text-gray-800">${cliente.nome}</span>
                            <span class="text-sm text-gray-600 block">Tel: ${cliente.telefone}</span>
                        </div>
                        <a href="${whatsappLink}" target="_blank" class="text-green-500 hover:text-green-600">
                            <i class="fab fa-whatsapp text-2xl"></i>
                        </a>
                        `;
                        listaClientes.appendChild(li);
                    });
                } catch (error) {
                    console.error('Erro ao carregar clientes:', error);
                    showMessage(listaClientes, 'Erro ao carregar a lista de clientes.', true);
                }
            };

            logoutButton.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/logout', { method: 'POST', credentials: 'include' });
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                } finally {
                    window.location.href = '/login.html';
                }
            });

            verClientesButton.addEventListener('click', () => {
                modalClientes.classList.remove('hidden');
                carregarClientes();
            });

            btnFecharModalClientes.addEventListener('click', () => {
                modalClientes.classList.add('hidden');
            });

            btnCopiarLink.addEventListener('click', () => {
                const link = linkPainelClienteInput.value;
                copyToClipboard(link);
            });

            btnCompartilharWhatsapp.addEventListener('click', () => {
                const link = linkPainelClienteInput.value;
                const mensagem = mensagemCompartilharTextarea.value.trim() || 'Olá! Use este link para agendar um horário comigo.';
                const textoCompleto = `${mensagem}\n\n${link}`;
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(textoCompleto)}`;
                window.open(whatsappUrl, '_blank');
            });

            initPage();
        });
    </script>
</body>

</html>